# 三层股权穿透CSV数据取数逻辑说明

本文档旨在解释 `三层股权穿透输出数据.csv` 文件（以下简称CSV文件）的数据结构，特别是关于如何理解和使用 `level`（层级）字段以及 `children`（子公司/被投资方）字段来分析股权穿透关系。

## 文件结构概览

CSV文件包含以下主要列：

-   `eid`: 实体ID，唯一标识一个公司或个人。
-   `name`: 实体名称。
-   `type`: 实体类型 (例如：'E' 代表企业, 'P' 代表个人)。
-   `short_name`: 实体简称。
-   `amount`: 投资金额或股份数额。对于非 `level 0` 的实体，这通常指其直接上层股东对其的投资额。
-   `percent`: 持股比例。对于非 `level 0` 的实体，这通常指其直接上层股东对它的持股比例。
-   `sh_type`: 股东类型。
-   `level`: 实体在股权结构中的层级。`level 0` 通常代表分析的顶层公司。
-   `count`: 该实体直接投资的下一层实体（子公司）的数量。
-   `children`: 一个JSON字符串，详细列出了该实体直接投资的所有下一层实体（子公司）的信息。
-   `parent_id`: 该实体的直接上层（父）实体的 `eid`。对于 `level 0` 的实体，此字段通常为空。
-   `actl_cntr_name`: 实际控制人名称。
-   `actl_cntr_pct`: 实际控制人持股比例。

**重要说明：** 根据分析，`actl_cntr_name` 和 `actl_cntr_pct` 这两个字段的数据**仅对 `level 0` 的公司有效并被填充**。对于 `level > 0` 的公司，这些字段通常为空或无实际意义。

## Level 0 实体与 Children 字段

核心理解：**对于 `level 0` 的实体，其行数据中的 `children` 字段包含了从该顶层公司出发的完整股权穿透信息（通常是三层）。**

-   **嵌套结构**: `children` 字段是一个JSON数组。数组中的每一个JSON对象代表一个被当前实体直接投资的子公司（通常是 `level 1`）。
    -   每个这样的子公司JSON对象自身也可能包含一个 `children` 字段，其中列出了它所投资的下一层公司（通常是 `level 2`），以此类推。
    -   这种嵌套结构使得单从 `level 0` 实体的行数据中，就可以递归地解析出整个下游投资链条。

-   **子公司属性**: `children` JSON对象中包含了子公司的主要属性，例如：
    -   `eid`, `name`, `type`, `short_name`
    -   `amount`, `percent` (相对于其父公司的投资)
    -   `level` (通常是父实体 `level + 1`)
    -   `count` (该子公司自己投资的下层实体数量)
    -   以及它自己的 `children` JSON 列表。

## 数据冗余与完整性

-   **独立行**: CSV文件中的每一行都代表一个独立的实体。即使一个公司（例如 `公司B`）在 `公司A` (`level 0`) 的 `children` 字段中被提及（作为 `level 1`），`公司B` 自身在CSV文件中也会有自己独立的一行数据。在 `公司B` 的独立行中，其 `parent_id` 会指向 `公司A` 的 `eid`。

-   **为何 `level 0` 行可能足够**:
    1.  如前所述，`actl_cntr_name` 和 `actl_cntr_pct` 仅与 `level 0` 公司相关。
    2.  `level 0` 公司行内的嵌套 `children` JSON 结构，已经包含了构建从该 `level 0` 公司出发的完整股权投资树所需的所有下游公司的主要属性和它们之间的投资关系。

## 仅使用 Level 0 行数据的考量

如果系统的目标是分析和展示从已知的顶层公司（`level 0`）开始的股权穿透结构：

-   **可行性**: 理论上，可以只筛选出CSV文件中 `level` 为 `0` 的行。然后，通过递归解析这些行中的 `children` JSON字段，来重建完整的下游股权链。
-   **信息保留**: 这种方法可以保留所有下游公司的主要描述性属性（名称、类型、层级、被投资比例等）以及它们之间的投资关系。由于实际控制人信息仅与 `level 0` 相关，这部分信息不会丢失。
-   **处理方式调整**:
    -   如果数据处理脚本（如图构建器 `graph_builder.py`）之前依赖于读取每一行并通过 `parent_id` 建立连接，那么在只提供 `level 0` 行的情况下，这部分逻辑将不再适用。
    -   脚本需要依赖于对 `children` JSON的递归解析来构建图模型。`graph_builder.py` 中的 `_parse_children_recursive` 函数已具备此功能。

## 总结

`level 0` 实体的行，通过其嵌套的 `children` 字段，为我们提供了一个集中的视角来观察和分析其完整的下游股权投资网络。在特定条件下（即下游公司的所有关键属性都包含在 `children` JSON中，且某些顶层特有属性如实际控制人信息已明确只属于 `level 0`），仅使用 `level 0` 的行数据来构建相关股权图是可行的，但这可能需要调整数据的处理和解析逻辑。 