# 企业股权与交易关系异构图分析系统

## 项目概述

本项目是一个企业股权与交易关系异构图分析系统，旨在通过整合企业股权穿透数据与交易数据，构建企业之间的多层次关系图谱，实现对企业关系网络的全面分析。系统能够将企业之间的股权关系与交易关系结合，形成异构图网络模型，便于发现企业间的直接与间接关联，为企业关系分析提供全面视角。

## 功能特点

1. **数据转换与整合**：将Excel格式的原始数据转换为CSV，支持多种数据源整合
2. **股权关系图谱构建**：基于股权穿透数据构建企业间股权关系图
3. **交易数据整合**：将交易数据与股权关系整合，构建异构关系图
4. **关系网络分析**：对异构图中的节点和关系进行探索性分析
5. **可视化与报告**：生成分析报告和可视化结果，支持决策分析

## 技术架构

- 使用Python作为主要开发语言
- 基于NetworkX库进行图数据结构构建与分析
- 使用Pandas进行数据处理和分析
- 使用Matplotlib进行数据可视化
- 采用GraphML作为图数据存储格式

## 数据处理流程

整个系统的处理流程分为四个主要阶段：

1. **数据转换** (convert_excel_to_csv.py)
   - 将Excel格式的原始数据转换为CSV格式
   - 标准化数据，处理缺失值和异常值
   - 输出：交易数据.csv，股权穿透数据.csv

2. **股权关系图构建** (graph_builder.py)
   - 读取股权穿透CSV数据
   - 构建企业间股权关系图
   - 计算关键节点与边的属性
   - 输出：outputs/shareholder_graph.graphml

3. **交易数据整合** (add_transaction.py)
   - 读取股权关系图和交易数据
   - 将交易对象映射到现有图结构中
   - 标记企业角色（供应商、客户、成员单位）
   - 添加交易关系边
   - 输出：outputs/final_heterogeneous_graph.graphml 及 outputs/add_transaction.log

4. **异构图分析** (exploratory_analysis.py)
   - 对最终异构图进行探索性分析
   - 分析节点类型分布
   - 分析交易关系网络
   - 社区结构检测与分析
   - 输出：各类分析文本报告，保存在outputs/reports目录

## 关于"数据缺失"类型节点

在异构图中，标记为"数据缺失"的节点是指：

- 在交易数据中出现，但在三层股权穿透数据中不存在的公司节点
- 或虽在股权穿透数据中存在，但缺少有效的类型标识信息

这些节点表明我们的数据源中存在不完整的企业信息，需要后续通过数据补充来完善。这是正常现象，特别是在大规模数据整合过程中，不同数据源之间通常会有覆盖范围的差异。

## 使用方法

### 环境配置

```bash
# 安装依赖
pip install -r requirements.txt
```

### 运行流程

可以通过main.py一键运行整个系统：

```bash
# 一键执行全流程
python main.py
```

或者分步执行各个模块：

```bash
# 步骤1：转换Excel为CSV
python convert_excel_to_csv.py

# 步骤2：构建股权关系图
python graph_builder.py

# 步骤3：整合交易数据
python add_transaction.py

# 步骤4：异构图分析
python exploratory_analysis.py
```

### 输出文件

- `outputs/shareholder_graph.graphml`：股权关系图
- `outputs/final_heterogeneous_graph.graphml`：最终异构图
- `outputs/add_transaction.log`：交易数据整合日志
- `outputs/exploratory_analysis.log`：分析过程日志
- `outputs/reports/`：各类分析报告CSV和MD文件
- `outputs/images/`：可视化图表

## 注意事项

1. 请确保输入的Excel文件格式符合系统要求
2. 对于大规模数据处理，可能需要更多内存资源
3. 首次运行时会自动创建outputs目录及其子目录
4. 同一个公司可能同时作为供应商和客户出现，这是正常情况
5. 运行过程中请留意终端输出和日志文件，了解处理进度和可能的问题

# 风险评估系统

本项目实现了一个基于图分析的企业风险评估系统，通过构建股权网络和交易网络的异构图，对企业间的关联关系进行深度分析，识别潜在风险点。

## 核心功能

1. **数据整合**：整合企业股权关系和交易数据，构建异构关系图
2. **风险识别**：基于网络分析方法，识别企业间的关键风险关系
3. **高性能分析**：优化的分析算法，支持大规模数据的高效处理
4. **结果可视化**：生成详细的分析报告和统计结果

## 环境要求

- Python 3.8+
- NetworkX 2.8+
- pandas 1.4+
- python-louvain (community模块)

可通过以下命令安装依赖：
```bash
pip install -r requirements.txt
```

## 使用说明

### 1. 数据准备

- 确保`三层股权穿透输出数据.csv`文件包含正确的股权关系数据
- 确保`化工公司样本测试数据0521.xlsx`包含正确的交易数据

### 2. 转换交易数据

```bash
python convert_excel_to_csv.py
```
此步骤将Excel格式的交易数据转换为CSV格式

### 3. 构建股权图

```bash
python graph_builder.py
```
此步骤会构建股权关系图，输出为`outputs/shareholder_graph.graphml`

### 4. 添加交易数据，构建异构图

```bash
python add_transaction.py
```
此步骤将交易关系添加到股权图中，形成异构图，输出为`outputs/final_heterogeneous_graph.graphml`

### 5. 分析异构图

```bash
python exploratory_analysis.py
```
此步骤会分析异构图，输出分析报告和统计数据

### 6. 查看分析结果

分析结果保存在以下文件中：
- `outputs/reports/heterogeneous_graph_analysis.txt`：主分析报告
- `outputs/reports/graph_summary.csv`：图的基本统计数据
- `outputs/reports/top_entities.csv`：重要实体信息

## 高级功能

如需进行更深入的分析，可使用以下脚本：

```bash
# 高级网络分析
python advanced_analysis.py

# 查询特定节点的邻居关系
python query_node_neighborhood.py "目标企业名称"
```

# 股权关系分析系统

这是一个基于网络图分析的股权关系可视化和分析系统，可以展示企业间的投资关系，进行中心性分析，检测循环持股关系等。

## 功能特点

1. **图模型基本信息展示**
   - 节点和边的总数统计
   - 被投资最多的实体排名
   - 投资最多的实体排名
   - PageRank中心性排名（精确到小数点后8位）
   - 度中心性排名

2. **投资关系详情分析**
   - 支持公司名称搜索
   - 展示公司的投资方详细信息(包括PageRank值、投资数、被投资数等)
   - 展示公司被投资企业的详情
   - 支持在当前页面内查看投资方详情，无需跳转
   - 精确显示持股比例和投资关系
   - 投资方数据表格支持高亮选中行

3. **股权穿透分析**
   - 三层股权结构清晰展示：上游(投资方)、中游(当前公司)和下游(被投资企业)
   - 每层拥有专门的样式区分，增强可读性
   - 支持将任何公司设置为中心分析对象，实现灵活的股权链分析
   - 显示各层次的持股比例及PageRank值等重要指标
   - 支持折叠/展开各层次的详细信息

## 安装与运行

### 前提条件

- Python 3.7+
- pip包管理器

### 安装依赖

```bash
pip install -r requirements.txt
```

### 运行系统

```bash
python app.py
```

启动后，在浏览器中访问 http://localhost:8888 即可使用系统。

## 使用方法

1. 首页加载后，默认显示"分析概览"标签页，展示图模型的基本统计信息。

2. 在左侧边栏的搜索框中输入公司名称，按下Enter键或点击搜索按钮进行搜索。

3. 从搜索结果中选择一个公司，系统会自动切换到"投资关系详情"标签页，并显示该公司的投资方信息。

4. 在"投资关系详情"标签页中，您可以：
   - 查看所有投资方的详细信息，包括持股比例、PageRank值等
   - 查看公司的被投资企业列表
   - 点击"查看详情"可以在当前页面查看某个投资方的详细信息，包括其他投资关系
   - 点击被投资企业列表中的"查看详情"按钮可以将该企业设为中心查看点

5. 在"股权穿透分析"标签页中，您可以：
   - 点击"生成股权分析报告"按钮获取实时的股权穿透分析
   - 查看上游股权结构（投资方层），了解公司的投资方及相关指标
   - 查看中游企业（当前分析主体），包括基本信息和关键指标
   - 查看下游股权结构（被投资企业层），了解公司投资的企业
   - 点击"设为中心企业"按钮可以将任何相关公司设为新的分析中心
   - 折叠/展开各层的详细信息，灵活查看关心的数据

## 数据结构

系统基于CSV文件构建图模型，CSV应包含以下字段：
- name: 实体名称
- eid: 实体ID（可选）
- type: 实体类型（'P'表示个人，'E'表示企业，'UE'表示境外企业）
- level: 实体层级
- parent_id: 父节点ID
- children: 子节点JSON数据
- percent: 持股比例

## 文件说明

- app.py: Flask应用入口文件
- graph_builder.py: 图模型构建模块
- graph_model.py: 图模型基础分析
- advanced_analysis.py: 高级网络分析
- query_node_neighborhood.py: 节点邻域查询
- templates/: HTML模板目录
- static/: 静态资源目录（CSS、JS等）

## 报告生成脚本

系统提供了多个独立脚本，可直接生成分析报告和可视化输出，无需启动Web界面。这些脚本可以批量处理数据，生成静态报告，适用于定期分析或大规模数据处理场景。

### advanced_analysis.py - 高级网络分析报告

该脚本执行深度网络分析并生成综合报告：

```bash
python advanced_analysis.py
```

**主要功能：**
- 中心性分析：计算并输出度中心性、PageRank中心性、接近中心性、中介中心性和特征向量中心性
- 社区检测：识别并可视化网络中的社区结构
- 关键控制者分析：识别网络中控制多个实体的关键股东

**输出文件：**
- `outputs/reports/advanced_analysis_report.txt`: 包含详细分析结果的文本报告
- `outputs/images/股权关系社区结构.png`: 社区结构可视化图

### visualize_graph_construction.py - 图构建可视化

该脚本逐步可视化图的构建过程，帮助理解数据如何形成网络：

```bash
python visualize_graph_construction.py
```

**主要功能：**
- 逐行读取CSV数据并动态可视化NetworkX图的构建过程
- 展示节点和边的添加过程，直观展示网络的形成
- 生成图构建统计信息

**参数定制：**
- rows_to_visualize: 限制处理的行数（默认100行）
- pause_duration: 每步可视化的暂停时间（默认0.7秒）
- save_final: 是否保存最终图状态（默认是）

**输出文件：**
- `outputs/images/graph_construction_final.png`: 最终图状态的可视化
- `outputs/reports/graph_construction_stats.txt`: 图构建过程的统计信息

### 投资方查询.py - 特定公司投资关系分析

该脚本可快速查询特定公司的投资关系并生成详细报告：

```bash
# 查询特定公司的投资关系
python 投资方查询.py "公司名称"

# 进行全局共同投资方分析
python 投资方查询.py --global
```

**主要功能：**
- 查询指定公司的上游投资方和下游被投资企业
- 显示投资方的详细画像（类型、PageRank值、度中心性、投资数、被投资数等）
- 展示持股比例信息
- 全局分析模式下，识别存在多个股东共同投资的公司

**适用场景：**
- 快速获取特定公司的投资关系
- 发现复杂投资结构中的共同投资行为
- 从命令行直接生成简洁的投资关系报告

## 技术栈

- 后端: Python, Flask, NetworkX
- 前端: Vue.js, Element UI, Axios
- 数据可视化: Element UI组件 

## 最新优化

- PageRank值显示优化：所有PageRank值统一精确到小数点后8位，确保数值准确可比
- 投资方详情展示优化：在当前页面直接显示投资方详情，避免频繁页面跳转
- 被投资企业功能增强：添加更完整的被投资企业查看功能
- 三层股权穿透设计：全新设计的三层结构，更清晰展示股权关系链
- 交互功能优化：添加"设为中心企业"功能，支持沿着股权链灵活分析 

## 异构图分析流程

本项目实现了将股权关系和交易关系整合为异构图，并进行深度分析的完整流程。主要步骤如下：

### 1. 数据准备和转换

1. 使用`convert_excel_to_csv.py`将Excel格式的交易数据转换为CSV格式
   ```bash
   python convert_excel_to_csv.py
   ```

2. 使用`graph_builder.py`构建股权关系图
   ```bash
   python graph_builder.py
   ```

### 2. 异构图构建

使用`add_transaction.py`将交易数据添加到股权图中，形成包含多种节点类型和边类型的异构图
   ```bash
   python add_transaction.py
   ```

主要节点类型：
- 股东：股权关系中的参与者
- 成员单位：参与交易的核心企业
- customer：客户企业
- supplier：供应商企业

主要边类型：
- 控股：表示股权关系
- 交易：表示商业交易关系

### 3. 异构图分析

使用`exploratory_analysis.py`对异构图进行全面分析，生成详细报告
   ```bash
   python exploratory_analysis.py
   ```

分析内容包括：
- 基本统计信息（节点类型、边类型分布）
- 连通性分析（连通分量识别与解释）
- 中心性分析（度中心性、PageRank中心性）
- 社区检测（社区结构与核心成员）
- 跨社区关系分析

每项分析都包含了详细的非技术性文字说明，便于非技术人员理解结果含义。

### 4. 输出文件

分析结果保存在以下文件中：
- `outputs/reports/exploratory_analysis_report.md`：主要分析报告
- `outputs/reports/graph_summary.csv`：图的基本统计数据，包含详细文字说明
- `outputs/reports/top_entities.csv`：重要实体信息，包含各实体重要性说明

## 系统整体架构

本风险评估系统整合了多模块协同工作：

1. **数据处理模块**：
   - 股权数据处理
   - 交易数据处理和转换

2. **图构建模块**：
   - 股权图构建
   - 异构图集成

3. **分析模块**：
   - 基础网络分析
   - 高级分析
   - 异构图分析，包含详细文字解释
   - 风险识别

4. **应用模块**：
   - 查询和检索功能
   - 风险预测和评估

整个系统设计兼顾了性能和实用性，通过去除计算密集型操作和可视化部分，大大提高了处理效率，使系统能够应用于生产环境中的大规模数据分析。非技术人员也能通过详细的文字说明理解分析结果。 