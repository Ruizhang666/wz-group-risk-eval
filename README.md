# 物产中大图风控系统

## 项目概述

本项目是"物产中大图风控系统"，是一个基于图论和机器学习的企业风险控制系统，旨在通过整合和分析企业股权与交易数据，构建企业间的复杂关系图谱，识别潜在的股权循环、交易异常等风险模式。系统采用模块化设计，结合了传统的规则引擎与先进的机器学习模型，提供从数据处理、图谱构建、风险检测到智能分析与决策支持的完整解决方案。机器学习的引入使得系统能够从历史数据中学习并自适应新的风险模式，显著提升风险识别的准确性和前瞻性。

## 🎯 核心特色

- **🔄 先进的环路检测算法**：支持3-8节点多种复杂环路模式检测，结合规则与机器学习进行精准识别。
- **🧠 智能风险洞察**：利用机器学习模型（如XGBoost、隔离森林）自动学习风险特征，发现已知及未知的复杂风险模式。
- **⚡ 超高性能优化**：核心算法实现70倍性能提升，保障大规模图谱分析的效率。
- **🔧 灵活的参数配置与模型调优**：提供严格/宽松/平衡/性能四种预设模式，并支持机器学习模型的参数调整与迭代优化。
- **📊 全面可视化分析与可解释性**：自动生成阈值推荐、风险评估报告，并提供机器学习模型的可解释性分析，理解决策依据。
- **🖥️ 跨平台兼容**：支持Windows/Linux/macOS，提供NetworkX和igraph双引擎。
- **📈 动态风险评分与预警**：基于多维度指标和机器学习模型输出动态风险评分，实现更精准的风险预警。

## 🚀 功能特点

### 核心功能
1. **数据转换与清洗**：将原始数据（Excel/CSV）转换为标准化格式，进行数据校验与修复。
2. **股权图构建**：基于股权穿透数据构建企业关系网络，识别深层股权结构。
3. **异构图生成**：整合股权关系、交易数据、工商信息等多源数据，构建复合图结构。
4. **智能风险检测与画像**：
    - **规则引擎驱动**：基于预设规则快速筛选明显风险。
    - **机器学习驱动**：利用监督学习模型识别已知复杂风险，利用无监督模型发现异常与未知风险。
    - **风险画像生成**：对高风险实体和环路进行多维度画像，揭示风险成因与传导路径。
5. **交易关系分析**：深度挖掘交易模式、资金链路和异常行为，结合图算法分析交易网络的稳定性与风险。
6. **股东情况分析**：股权集中度、控制关系评估，识别关键股东与潜在一致行动人。
7. **机器学习模型管理**：支持模型训练、评估、部署与在线更新，确保模型持续有效。

### 新一代环路检测系统
- **🔍 多层级检测**：支持3-8节点环路，覆盖简单到复杂的所有模式，应用图算法优化检测效率。
- **⚡ 性能突破**：优化后的筛选算法实现3分钟→2.6秒的性能飞跃。
- **🎯 精准筛选与排序**：从海量候选环路中精确识别高风险目标，并根据机器学习评分进行优先级排序。
- **🔧 智能配置与阈值推荐**：基于数据特征自动推荐最优阈值参数，并结合机器学习模型动态调整。
- **📊 可视化分析与溯源**：全方位的指标分布、相关性分析，并支持对高风险环路的交互式可视化溯源。

## 🛠️ 技术架构

### 核心技术栈
- **开发语言**：Python 3.8+
- **图计算引擎**：NetworkX + igraph（双引擎支持）
- **数据处理**：Pandas + NumPy
- **可视化**：Matplotlib + Seaborn
- **机器学习**：Scikit-learn（风险评分）
- **并行计算**：Multiprocessing（性能优化）

### 系统架构
```
系统核心层
├── 数据处理层（Data Processing Layer）
│   ├── Excel/CSV数据转换
│   ├── 数据清洗与标准化
│   └── 数据验证与质量检查
├── 图构建层（Graph Construction Layer）
│   ├── 股权关系图构建
│   ├── 交易网络构建
│   └── 异构图整合
├── 算法引擎层（Algorithm Engine Layer）
│   ├── 环路检测引擎（igraph/NetworkX）
│   ├── 风险评分引擎（规则 + 机器学习模型）
│   ├── 异常检测算法（如隔离森林等）
│   └── 特征工程与模型训练模块
├── 分析服务层（Analysis Service Layer）
│   ├── 股东情况分析
│   ├── 交易关系分析
│   └── 风险评估服务
└── 可视化层（Visualization Layer）
    ├── 统计图表生成
    ├── 风险报告生成
    └── 交互式分析界面
```

## 📁 项目结构

```
物产中大图风控系统/
├── 📂 code/                          # 核心代码模块
│   ├── 🔧 config_parameters.py       # 参数配置中心
│   ├── 🔄 loop_detection.py          # 环路检测（igraph版）
│   ├── 🔄 loop_detection_nx.py       # 环路检测（NetworkX版，Windows兼容）
│   ├── ⚡ loop_filter_script.py      # 高性能环路筛选
│   ├── 📊 loop_metrics_visualization.py  # 可视化分析工具
│   ├── 🏗️ graph_builder.py          # 图构建模块
│   ├── 📈 add_transaction.py         # 交易数据整合
│   ├── 📋 exploratory_analysis.py    # 探索性分析
│   ├── 💎 loop_profiling.py          # 环路画像分析
│   └── 👥 analyze_control_edges.py   # 股东控制关系分析
├── 📂 data/                          # 原始数据存储
├── 📂 model/                         # 图模型文件
│   ├── final_heterogeneous_graph.graphml
│   └── simplified_loop_detection_graph.graphml
├── 📂 outputs/                       # 输出结果目录
│   ├── 📊 reports/                   # 分析报告
│   ├── 🔄 loop_results/              # 环路检测结果
│   ├── 🔍 loop_analysis/             # 环路深度分析
│   ├── 🔍 loop_filter/               # 筛选后的环路
│   ├── 👥 shareholder_analysis/      # 股东分析结果
│   ├── 📈 visualizations/            # 可视化图表
│   └── 📝 log/                       # 系统日志
├── 📂 config/                        # 配置文件
├── 📂 backup/                        # 备份文件
├── 📄 main.py                        # 主执行脚本
├── 📄 requirements.txt               # 依赖列表
├── 📄 README.md                      # 项目说明
└── 📄 环路筛选参数配置教程.md         # 参数配置详细教程
```

## 🔄 核心处理流程

### 完整数据处理管道

```mermaid
graph TB
    A[原始数据] --> B[数据转换与清洗]
    B --> C[股权图构建]
    C --> D[交易数据整合]
    D --> E[异构图生成]
    E --> F[环路检测 (规则初步筛选)]
    F --> G[机器学习风险评估与排序]
    G --> H[高性能筛选优化 (结合ML结果)]
    H --> I[指标计算与深度分析]
    I --> J[可视化、报告与预警]
    J --> K[风险处置与反馈闭环]
```

### 详细执行步骤

1. **📊 数据预处理** (`convert_excel_to_csv.py`)
   - Excel/CSV文件自动转换为CSV/Parquet等高效格式。
   - 数据清洗、去重、标准化、缺失值处理。
   - 数据质量校验与报告生成。

2. **🏗️ 图结构构建** (`graph_builder.py`)
   - 基于股权数据构建企业股权关系图。
   - 计算节点基础属性（如注册资本、成立年限）和边属性（如持股比例、投资金额）。
   - 生成GraphML或图数据库兼容格式的图文件。

3. **🔗 异构图整合** (`add_transaction.py`, `enrich_graph_features.py`)
   - 整合股权关系、交易数据、工商变更、舆情信息等多源数据。
   - 构建包含多种类型节点（企业、个人、账户）和关系（投资、交易、担保）的异构图。
   - 进行图特征工程，为下游机器学习模型准备输入。

4. **🔍 环路检测与初步筛选** (`loop_detection.py` / `loop_detection_nx.py`)
   - 基于图算法高效检测3-8节点的潜在股权环路。
   - 应用基础规则（如环路涉及金额、节点数量）进行初步筛选，减少后续分析压力。

5. **🧠 机器学习风险评估** (`risk_modelling/ml_risk_control.py`)
   - **特征工程**：针对每个环路提取结构特征、交易特征、节点属性特征等。
   - **监督学习评分**：使用预训练的XGBoost等模型对环路进行风险评分，识别已知风险模式。
   - **无监督异常检测**：应用隔离森林等算法发现偏离正常模式的异常环路，预警潜在未知风险。
   - 详细设计请参见：[机器学习风控模块说明](risk_modelling/README.md)

6. **⚡ 高性能筛选与优化** (`loop_filter_script.py`)
   - 结合规则引擎与机器学习评分结果，对环路进行综合排序和筛选。
   - 应用多维度阈值（如交易金额、持股比例、风险评分）进行精细化筛选。
   - 70倍性能提升的优化算法确保大规模数据处理能力。

7. **📈 可视化分析与报告** (`loop_metrics_visualization.py`, `report_generator.py`)
   - 生成全面的指标分布图、相关性热力图、风险等级分布图。
   - 对高风险环路进行可视化展示，支持交互式探索。
   - 自动生成包含关键发现、风险评估和处置建议的分析报告。

8. **📋 深度分析与画像** (`loop_profiling.py`, `analyze_control_edges.py`)
   - 对高风险环路进行深度画像，分析其形成机制、参与主体特征、潜在影响。
   - 分析股东控制链条、识别实际控制人，评估控制权风险。
   - 进行风险传导路径分析。

## ✨ 机器学习赋能：构建智能风控新范式

为了应对日益复杂和隐蔽的金融风险，本系统深度融合了机器学习技术，从“规则驱动”向“数据驱动+知识驱动”的智能风控模式升级。

### 1. 为什么引入机器学习？
传统基于规则的风控系统在处理模式固定、特征明显的风险时表现良好，但面对以下挑战时略显不足：
- **未知风险的识别**：难以发现超出预设规则的新型风险手法。
- **复杂模式的挖掘**：对于多因素交织、特征隐蔽的复杂风险模式，人工定义规则难度大、易遗漏。
- **规则的适应性与维护**：风险模式持续演变，规则库需要频繁更新，维护成本高。
- **误报与漏报的平衡**：静态规则难以在不同场景下灵活调整，容易导致过高误报或漏报。

机器学习通过其强大的学习能力和模式识别能力，为解决上述痛点提供了有效途径：
- **自动学习风险模式**：从海量历史数据中自动归纳和学习风险特征，无需人工预先定义所有规则。
- **发现未知与异常**：通过无监督学习算法，能够识别与正常行为模式显著偏离的异常点，预警潜在未知风险。
- **提升识别精度**：通过复杂的非线性模型，能够更精准地刻画风险边界，有效降低误报和漏报。
- **持续自适应进化**：模型可以通过持续的数据反馈进行迭代更新，不断提升对新风险模式的适应能力。

### 2. 核心机器学习能力
本系统的机器学习模块（详见 `risk_modelling/` 目录）主要构建了以下核心能力：

- **智能特征工程 (Intelligent Feature Engineering)**：
    - **多维度特征提取**：从环路结构、参与方属性、交易行为、时间序列等多个维度提取数百个精细化特征。例如：环路紧密度、节点中心性、平均交易金额、交易频率、股权集中度、最短路径等。
    - **动态特征生成**：结合图嵌入技术（如Node2Vec, GraphSAGE），将节点的结构信息和属性信息编码为低维向量表示，捕捉更深层次的语义关联。
    - **特征选择与降维**：利用互信息、卡方检验、PCA等方法筛选最相关的特征，减少噪声，提升模型效率和泛化能力。

- **双重风险识别引擎 (Dual Risk Identification Engine)**：
    - **监督学习模型 (Supervised Learning for Known Risks)**：
        - **模型选择**：主要采用XGBoost、LightGBM等梯度提升决策树模型，这些模型在处理表格型数据、捕捉复杂非线性关系方面表现出色，并具有良好的可解释性。
        - **样本构建**：基于历史已确认的风险案例（如监管处罚、公开负面新闻、内部审计发现等）构建正样本，从未发生风险的案例中抽取负样本。关注样本不平衡问题，采用过采样（SMOTE）、欠采样或代价敏感学习等策略。
        - **模型训练与调优**：通过交叉验证、网格搜索/贝叶斯优化等方法选择最优超参数组合，防止过拟合。
        - **应用场景**：精准识别与历史案例相似的已知高风险模式，如典型的虚假贸易环、关联交易非公允定价等。
    - **无监督异常检测 (Unsupervised Learning for Unknown/Anomalous Risks)**：
        - **模型选择**：主要采用隔离森林（Isolation Forest）、孤立点检测（Local Outlier Factor, LOF）、自编码器（Autoencoder）等算法。这些算法无需预先标注数据，擅长发现与正常数据分布显著不同的离群点。
        - **正常模式画像**：首先对大量正常交易或股权结构数据进行学习，构建“正常行为”的基线画像。
        - **异常评分与预警**：对于新的环路或实体，计算其偏离正常基线的程度（异常分数），当分数超过预设阈值时发出预警。
        - **应用场景**：发现与过往经验不同的新型风险手法、数据录入错误、潜在的欺诈信号等。

- **可解释的风险评分与洞察 (Explainable Risk Scoring & Insights)**：
    - **风险评分输出**：模型不仅输出二分类的风险标签（高/低风险），更提供连续的风险概率分数（0-1之间），便于进行风险排序和分级管理。
    - **特征重要性分析**：利用SHAP (SHapley Additive exPlanations)、LIME (Local Interpretable Model-agnostic Explanations) 等工具分析模型决策中各特征的贡献度，理解哪些因素导致了高风险判断。
    - **决策路径可视化**：对于树模型，可以可视化决策树的判断路径，直观展示风险判定的逻辑。
    - **案例级解释**：针对单个高风险案例，提供其关键风险特征和相似历史案例，辅助人工研判。

### 3. 实际应用与价值
将机器学习融入风控流程，能在多个环节创造显著价值：

- **场景1：日常风险筛查与优先级排序**
    - **问题**：每日新增大量交易和股权变更，人工审核压力巨大，难以高效识别高风险目标。
    - **ML方案**：
        1. 加载当日新增或变更的股权环路数据。
        2. 经过特征工程模块处理，提取相关特征。
        3. 输入监督学习模型和无监督模型，分别得到风险评分和异常评分。
        4. 结合两种评分（例如加权平均或设定组合规则），得到综合风险等级。
        5. 对环路按综合风险等级进行排序，优先推送Top N个高风险环路给人工审核团队。
    - **价值**：大幅减少人工初筛工作量，将专家精力聚焦于最可疑的案例，提升审核效率和精准度。

- **场景2：新型与未知风险预警**
    - **问题**：传统规则难以覆盖所有新兴的风险手法。
    - **ML方案**：
        1. 监控无监督异常检测模型的输出。
        2. 对于异常分数高，但监督学习模型风险评分不一定高的案例（可能因为缺乏历史相似样本），进行重点关注。
        3. 人工专家介入分析这些“异常但非已知高风险”的案例，判断是否为新型风险。
        4. 如确认为新型风险，则收集相关特征，将其作为新的正样本加入训练集，迭代优化监督学习模型。
    - **价值**：弥补规则系统的盲点，提前感知和预警潜在的新型风险，缩短风险响应滞后期。

- **场景3：风险演化分析与策略优化**
    - **问题**：风险模式和作案手法会随时间演变，风控策略需同步调整。
    - **ML方案**：
        1. 定期（如每月/每季度）使用最新的标注数据重新训练风险模型。
        2. 对比新旧模型的特征重要性排序，分析哪些风险因子的影响力在上升或下降。
        3. 追踪高风险群体的特征变化，识别风险演化的新趋势。
        4. 根据分析结果，动态调整风控规则、模型参数和人工审核策略。
    - **价值**：使风控体系具备持续学习和自适应能力，保持对动态风险环境的有效监控。

- **场景4：辅助贷前审批与贷后监控 (若适用)**
    - **问题**：在信贷业务中，需要快速评估借款企业的潜在违约风险。
    - **ML方案**：
        1. 结合企业的股权图谱、交易数据、经营数据和舆情信息，构建企业风险画像。
        2. 利用机器学习模型预测其未来发生信用风险的概率。
        3. 在贷前审批中作为重要参考依据，在贷后管理中进行持续风险监控和预警。
    - **价值**：提升信贷决策的科学性和效率，有效控制信用风险。

### 4. 部署与迭代策略
成功的机器学习应用是一个持续迭代和优化的过程：

- **第一阶段：辅助决策与数据积累**
    - **目标**：验证模型有效性，积累高质量标注数据。
    - **行动**：不直接用ML模型做最终决策，而是将其输出作为人工审核的辅助信息。建立清晰的反馈机制，由业务专家对模型预警的案例进行复核和标注。
- **第二阶段：混合智能系统**
    - **目标**：逐步提升自动化水平，优化人机协作流程。
    - **行动**：当模型表现稳定且得到业务认可后，可将ML评分正式纳入风险评估体系。对于模型判断的低风险案例可适当降低审核频率或实现自动通过；中高风险案例则由人工重点审核。
- **第三阶段：智能化自主升级**
    - **目标**：构建更高级的智能风控能力。
    - **行动**：积累足够数据和经验后，探索引入更复杂的模型（如图神经网络GNN进行端到端的风险学习）、强化学习（用于动态策略优化）等前沿技术。实现更高级别的自动化、实时监控和风险预测能力。

通过上述设计，机器学习将不仅仅是一个技术模块，更是驱动整个风控体系向更智能、更精准、更高效方向发展的核心引擎。
更详细的机器学习模块技术实现，请参考 [机器学习风控模块详细说明](risk_modelling/README.md)。

## 🚀 快速开始

### 环境配置

```bash
# 1. 克隆项目（如果适用）
git clone [项目地址]
cd 物产中大图风控系统

# 2. 安装依赖
pip install -r requirements.txt

# 3. 验证环境
python -c "import networkx, pandas, matplotlib; print('环境配置成功！')"
```

### 运行方式

#### 🎯 一键执行（推荐）
```bash
python main.py
```

#### 🔧 模块化执行
```bash
# 数据处理
python code/convert_excel_to_csv.py
python code/graph_builder.py
python code/add_transaction.py

# 环路分析
python code/loop_detection.py          # 或 loop_detection_nx.py (Windows)
python code/loop_filter_script.py      # 高性能筛选

# 可视化分析
python code/loop_metrics_visualization.py

# 深度分析
python code/loop_profiling.py
python code/analyze_control_edges.py
```

#### ⚙️ 参数配置
```bash
# 查看和修改配置参数
python code/config_parameters.py

# 应用预设配置模式
python -c "
from code.config_parameters import config
config.apply_quick_config('strict_mode')  # 严格模式
config.print_current_config()
"
```

## 📊 输出结果说明

### 核心输出文件
- **📈 可视化图表** (`outputs/visualizations/`)
  - `loop_metrics_distribution.png` - 指标分布图
  - `correlation_analysis.png` - 相关性分析
  - `threshold_analysis.png` - 阈值影响分析
  - `risk_analysis.png` - 风险等级分析

- **📋 分析报告** (`outputs/reports/`)
  - `threshold_recommendations.txt` - 阈值推荐报告
  - `loop_analysis_summary.csv` - 环路分析汇总
  - `risk_assessment_report.md` - 风险评估报告

- **🔍 检测结果** (`outputs/loop_results/`, `outputs/loop_filter/`)
  - `equity_loops_optimized.txt` - 完整环路检测结果
  - `filtered_high_risk_loops.csv` - 筛选后的高风险环路
  - `loop_statistics.json` - 检测统计信息

### 性能指标
- **检测速度**：25,235个环路 → 2.6秒处理完成
- **筛选精度**：从候选环路中识别出65个高风险目标
- **内存优化**：支持大规模图数据处理（10万+节点）
- **兼容性**：Windows/Linux/macOS全平台支持

## ⚙️ 配置与优化

### 预设配置模式

| 模式 | 适用场景 | 交易金额阈值 | 风险分数阈值 | 预期结果比例 |
|------|----------|--------------|--------------|--------------|
| **严格模式** | 重点监控 | ≥100万元 | ≥0.5 | ~7.5% |
| **平衡模式** | 日常分析 | ≥10万元 | ≥0.3 | ~26.9% |
| **宽松模式** | 全面排查 | ≥1万元 | ≥0.1 | ~57.5% |
| **性能模式** | 快速检测 | 优化性能 | 降低精度 | 可配置 |

### 参数配置指南

详细的参数配置教程请参考：[环路筛选参数配置教程.md](./环路筛选参数配置教程.md)

## 🔧 系统要求

### 基础环境
- **Python版本**：3.8+ 
- **内存要求**：建议8GB+（大数据集需要16GB+）
- **存储空间**：建议10GB+（包含数据和输出文件）
- **操作系统**：Windows 10+/macOS 10.14+/Ubuntu 18.04+

### 依赖库版本
```
pandas>=1.3.0
numpy>=1.21.0
networkx>=2.6.0
matplotlib>=3.4.0
seaborn>=0.11.0
python-igraph>=0.9.0  # 可选，Linux/macOS推荐
scikit-learn>=1.0.0
```

## 🐛 故障排除

### 常见问题

1. **Windows系统igraph安装失败**
   ```bash
   # 使用NetworkX版本
   python code/loop_detection_nx.py
   ```

2. **中文字体显示问题**
   - 系统会自动尝试配置中文字体
   - 如有问题，请安装SimHei或Arial Unicode MS字体

3. **内存不足错误**
   ```python
   # 在config_parameters.py中调整
   config.loop_detection.max_cycles_to_process = 50000  # 减少处理量
   config.loop_detection.memory_limit_mb = 2048         # 降低内存限制
   ```

4. **性能优化建议**
   - 启用多进程：`enable_multiprocessing = True`
   - 使用igraph引擎（Linux/macOS）
   - 应用性能模式配置

## 🤝 贡献指南

### 代码规范
- 遵循PEP 8编码规范
- 使用中文注释和文档字符串
- 保持模块化和可扩展性设计

### 提交流程
1. Fork项目仓库
2. 创建功能分支
3. 编写测试用例
4. 提交Pull Request

## 📄 许可证

本项目采用 [MIT许可证](LICENSE)

## 📧 联系方式

如有问题或建议，请联系项目维护团队。

---

**🎯 物产中大图风控系统 - 让风险控制更智能、更精准！**
