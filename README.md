# 物产中大图风控系统

## 项目概述

本项目是"物产中大图风控系统"，旨在通过整合和分析企业股权与交易数据，构建企业间的复杂关系图谱，识别潜在风险，特别是股权闭环等风险模式。系统通过一系列自动化脚本处理数据、构建图模型、执行分析并生成报告。

## 功能特点

1.  **数据转换**：将原始数据（如Excel格式）转换为适合图分析的CSV格式。
2.  **股权图构建**：基于股权穿透数据构建企业间的股权关系网络。
3.  **异构图生成**：整合股权关系与交易数据，形成包含多种节点和关系类型的异构图。
4.  **图分析与报告**：对构建的异构图进行深入分析，提取关键洞察并生成结构化报告。
5.  **股权闭环检测**：专门针对股权网络中的循环持股（闭环）现象进行检测和分析。
6.  **闭环分析与统计**：对检测到的闭环进行深入分析，计算关键统计指标，生成闭环画像。
7.  **交易关系分析**：分析闭环中的交易关系，包括上游-成员公司和成员公司-下游的交易统计和时间序列分析。
8.  **股东情况分析**：分析企业股东结构和控股关系，评估股权集中度，识别关键股东和潜在风险。

## 新增功能

### 扩展闭环检测功能

- **多种环路模式**: 系统现在支持多种环路模式的检测，包括4节点、5节点、6节点、7节点和8节点环路，并支持多种类型变体。
- **节点数筛选**: 可以通过修改`loop_detection.py`中的`NODE_COUNT`变量来指定要检测的环路节点数，灵活适应不同分析需求。
- **优化输出格式**: 重命名闭环类型，使其更加直观（如"4节点环路"而非"一级闭环"），并为每种类型生成详细的统计信息。

### 闭环分析工具

- **loop_profiling.py**: 新增脚本，用于对检测到的闭环进行深入分析，创建闭环"画像"。该工具读取闭环检测结果和异构图，计算各种统计指标，并生成结构化的闭环分析报告和数据表格。
- **交易关系提取**: 从异构图中提取闭环中的交易关系，区分上游到成员公司和成员公司到下游的交易数据。
- **交易统计指标**: 计算闭环中的交易总额、上游-成员公司交易总额和平均金额、成员公司-下游交易总额和平均金额。
- **交易时间序列**: 记录交易发生的时间，提供上游-成员公司和成员公司-下游交易的时间序列数据，便于时间模式分析。
- **闭环指标统计**: 为每个闭环计算关键指标，便于风险评估和决策支持。

### 股东情况分析工具

- **analyze_control_edges.py**: 新增脚本，专门分析异构图中的控股边关系，特别关注股东-股东和股东-partner之间的控股关系，提取各类股东情况指标。
- **股东集中度分析**: 计算企业的股权集中度指标，包括赫芬达尔指数(HHI)、最大股东持股比例、前5大股东持股比例总和等，识别高集中度企业。
- **股东网络结构分析**: 构建股东控股网络，计算股东的平均入度(被投资数)和出度(投资数)，识别投资活跃度最高的关键股东。
- **股东投资多样性分析**: 评估股东的投资多样性，识别多种类型投资的多元化投资者，分析其投资偏好和策略。
- **潜在风险股东识别**: 识别交叉持股关系，发现股东之间的互相控股现象，评估潜在的利益输送风险。
- **控制链分析**: 分析股权控制链的长度和复杂性，识别隐藏的最终控制人，评估控制链带来的风险。

## 技术架构

-   主要开发语言：Python
-   核心库：
    -   Pandas：用于数据处理和转换。
    -   NetworkX：用于图数据结构的构建、分析和操作。
    -   igraph：用于高效的环路检测和图分析。
    -   NumPy：用于数值计算和统计分析。
    -   (可能还包括 Matplotlib/Seaborn 用于可视化，具体视脚本内容而定)

## 项目结构

```
物产中大图风控系统/
├── code/                     # 核心处理脚本
│   ├── convert_excel_to_csv.py
│   ├── graph_builder.py
│   ├── add_transaction.py
│   ├── exploratory_analysis.py
│   ├── loop_detection.py
│   ├── loop_profiling.py     # 新增：闭环分析与统计脚本
│   ├── loop_edge_analysis.py # 新增：闭环边分析脚本
│   └── ... (其他可能的辅助脚本)
├── data/                     # 存放原始数据和处理后的CSV数据
├── model/                    # 可能用于存放模型相关文件 (如机器学习模型，如果适用)
├── outputs/                  # 存放所有输出结果
│   ├── reports/              # 存放分析报告 (如CSV, MD, TXT文件)
│   ├── loop_results/         # 存放股权闭环检测的结果
│   ├── loop_analysis/        # 存放闭环分析结果和统计指标
│   ├── shareholder_analysis/ # 新增：股东情况分析结果
│   ├── log/                  # 存放各模块运行日志
│   └── images/               # (如果生成可视化图片) 存放图片文件
├── main.py                   # 项目主执行脚本
├── requirements.txt          # 项目依赖库列表
└── README.md                 # 项目说明文件
```

## 核心处理流程

系统通过 `main.py` 脚本协调执行以下核心步骤：

1.  **转换Excel为CSV** (`code/convert_excel_to_csv.py`)
    -   读取原始数据（通常为Excel文件）。
    -   进行数据清洗、格式转换，并输出为CSV文件，供后续步骤使用。

2.  **构建股权关系图** (`code/graph_builder.py`)
    -   读取股权相关的CSV数据。
    -   构建企业间的股权关系图模型。
    -   可能计算节点的初始属性。
    -   输出股权关系图文件 (例如 GraphML 格式)。

3.  **整合交易数据并生成异构图** (`code/add_transaction.py`)
    -   读取已构建的股权关系图和交易数据CSV文件。
    -   将交易信息整合到股权图中，形成包含多种节点类型（如公司、股东）和关系类型（如持股、交易）的异构图。
    -   输出最终的异构图文件和相关日志。

4.  **分析异构图并生成报告** (`code/exploratory_analysis.py`)
    -   对生成的异构图进行全面的探索性分析。
    -   可能包括节点度分布、中心性计算、社区检测等。
    -   生成详细的分析报告，保存在 `outputs/reports/` 目录下。

5.  **执行股权闭环检测** (`code/loop_detection.py`)
    -   在股权网络中检测是否存在循环持股（股权闭环）的模式。
    -   支持4-8节点多种类型环路的检测。
    -   可通过修改脚本中的`NODE_COUNT`变量指定要检测的节点数。
    -   输出闭环检测的结果，通常保存在 `outputs/loop_results/` 目录下。

6.  **闭环分析与统计** (`code/loop_profiling.py`)
    -   读取闭环检测结果和异构图数据。
    -   为每个闭环计算统计指标，创建闭环"画像"。
    -   分析闭环中的交易关系，包括上游到成员公司和成员公司到下游的交易。
    -   计算交易统计指标：交易总额、交易平均金额和交易时间序列。
    -   生成闭环基本信息表和闭环指标表，包含详细的交易分析数据。
    -   输出结果保存在 `outputs/loop_analysis/` 目录下。

7.  **股东情况分析** (可选步骤，使用 `analyze_control_edges.py`)
    -   加载异构图，分析控股边关系和分布。
    -   计算企业的股权集中度指标，识别高集中度公司。
    -   构建股东网络，识别关键股东和投资模式。
    -   分析股东投资多样性和控制链长度。
    -   识别交叉持股等潜在风险。
    -   输出分析结果，保存在 `outputs/shareholder_analysis/` 目录下。

## 使用方法

### 环境配置

确保您的Python环境中已安装所有必要的库。可以通过以下命令安装：

```bash
pip install -r requirements.txt
```

### 运行流程

#### 一键执行全流程

可以直接运行项目根目录下的 `main.py` 脚本，它将按顺序自动执行所有核心处理步骤：

```bash
python main.py
```

#### 分步执行各个模块

如果需要单独执行某个处理步骤，可以进入 `code/` 目录并运行相应的脚本：

```bash
# 步骤1：转换Excel为CSV
python code/convert_excel_to_csv.py

# 步骤2：构建股权关系图
python code/graph_builder.py

# 步骤3：整合交易数据并生成异构图
python code/add_transaction.py

# 步骤4：分析异构图并生成报告
python code/exploratory_analysis.py

# 步骤5：执行股权闭环检测（默认检测所有类型的环路）
python code/loop_detection.py

# 步骤6：执行闭环分析与统计
python code/loop_profiling.py
```
注意：分步执行时，请确保前置步骤已成功完成并生成了必要的输入文件。

### 配置闭环检测

如果仅需检测特定节点数的环路，可以修改 `code/loop_detection.py` 文件顶部的配置参数：

```python
# ===== 用户可配置参数 =====
# 设置要分析的节点数，如果为None则分析所有节点数的环路
# 可选值: 4, 5, 6, 7, 8 或 None (分析所有环路)
NODE_COUNT = 6  # 在这里修改要分析的节点数，例如分析6节点环路
# ========================
```

## 输出文件

所有处理结果和报告都将保存在 `outputs/` 目录下，具体子目录结构如下：

-   `outputs/reports/`: 存放各类分析报告，如异构图分析报告、统计摘要等。
-   `outputs/loop_results/`: 存放股权闭环检测的详细结果。
-   `outputs/loop_analysis/`: 存放闭环分析结果和统计指标表格，包括闭环基本信息表(loop_basic_info.csv)和闭环指标表(loop_metrics.csv)。闭环指标表包含了交易金额、交易次数、交易平均金额和交易时间等详细信息。
-   `outputs/shareholder_analysis/`: 存放股东情况分析结果，包括股权集中度指标、关键股东列表、投资多样性统计和风险评估数据等。
-   `outputs/log/`: 存放各个处理步骤的运行日志文件。
-   `outputs/images/`: (如果适用) 存放由分析过程生成的可视化图表。
-   `data/`: 包含处理过程中生成的中间CSV文件。
-   股权图和异构图文件 (例如 GraphML 格式) 通常也会保存在 `outputs/` 目录或其子目录中，具体路径请查看相应脚本的实现。

## 注意事项

1.  **数据准备**：确保 `data/` 目录中包含符合脚本要求的原始输入文件。文件格式和内容需遵循约定。
2.  **依赖安装**：在首次运行前，务必通过 `requirements.txt` 安装所有依赖库。
3.  **执行顺序**：如果选择分步执行，请严格按照数据处理流程的顺序进行。
4.  **资源消耗**：处理大规模数据集时，部分步骤（如图构建和复杂分析）可能需要较多的内存和计算时间。
5.  **日志查看**：运行过程中请关注终端输出，并检查 `outputs/log/` 目录下的日志文件以获取详细的执行信息和可能的错误提示。
