# 风险建模模块（risk_modelling）

## 模块定位
本模块专为企业级图风控系统设计，聚焦于环路风险的多维度建模与机器学习扩展，支持灵活集成与独立调用。

## 支持方法
- **多指标加权风险评分**：支持自定义权重、归一化方式
- **机器学习扩展**：可集成XGBoost、LightGBM、随机森林等模型
- **阈值推荐**：自动生成宽松/平衡/严格等多种业务场景下的阈值建议

## 输入输出格式
- **输入**：标准化环路指标表（CSV/Parquet），字段如`transaction_amount`、`risk_score`、`node_count`等
- **输出**：风险分数、风险等级、筛选建议、可视化图表

## 快速集成
1. 将环路指标数据导入本模块
2. 配置`risk_model_config.py`（可选）
3. 运行`risk_model_main.py`或调用核心API
4. 获取风险分数与筛选建议

## 典型用例
- **批量风险评分**：对所有闭环批量打分，输出高风险名单
- **ML模型训练**：自定义特征、标签，训练并评估ML模型
- **业务阈值推荐**：一键生成多场景阈值建议，辅助决策

## 与主系统的关系
- 可独立运行，也可作为主系统的子模块被`main.py`调用
- 输入输出与主系统完全兼容，便于数据流转

## 注意事项 & FAQ
- **自定义模型**：建议继承`BaseRiskModel`类，便于与主流程对接
- **特征工程**：请确保输入字段与主系统一致，避免字段缺失
- **依赖管理**：如用ML扩展，需额外安装`scikit-learn`、`xgboost`等
- **FAQ**：如遇模型导入/保存问题，优先检查依赖与路径

## 机器学习风控系统设计

### 1. 背景与需求：为何引入机器学习？

传统基于规则的风控系统在处理模式固定、特征明显的风险时表现良好，但面对日益复杂和隐蔽的金融风险挑战时，其局限性逐渐显现：

*   **未知风险的识别能力不足**：规则系统依赖人工预先定义的模式，难以发现超出经验范围的新型风险手法。
*   **复杂模式的挖掘困难**：对于多因素交织、特征隐蔽的复杂风险（如精心设计的交易网络、非显性关联方交易），人工定义规则的难度大、覆盖面有限且容易遗漏。
*   **规则的适应性与维护成本高**：金融市场和风险手段持续演变，规则库需要频繁更新迭代，这不仅耗时耗力，也难以保证规则的有效性和时效性。
*   **误报与漏报的平衡挑战**：静态规则难以在不同业务场景和风险容忍度下灵活调整，往往导致误报率过高（影响业务效率）或漏报率过高（风险敞口增大）。
*   **知识沉淀与复用效率低**：专家的经验和知识往往难以系统化、规模化地沉淀和复用。

机器学习，凭借其强大的从数据中学习和归纳模式的能力，为解决上述痛点提供了有效的技术途径。在本风控系统中引入机器学习，旨在：

*   **自动化学习风险模式**：从海量历史交易数据、股权结构数据和已识别的风险案例中自动归纳和学习风险特征，减轻对人工规则定义的依赖。
*   **提升未知与异常风险的发现能力**：通过无监督学习和异常检测算法，识别与正常行为模式显著偏离的个体或群体，从而预警潜在的未知风险。
*   **提高风险识别的精度与召回**：利用复杂的非线性模型更精准地刻画风险边界，在保证高召回率的同时，有效降低误报率。
*   **实现系统的持续自适应与进化**：模型可以通过新数据的持续喂养和反馈进行迭代更新，不断提升对新兴风险模式的识别和适应能力。
*   **赋能专家经验，提升决策效率**：将机器学习模型作为风控专家的智能助手，辅助其进行更高效、更精准的风险研判和决策。

### 2. 核心机器学习能力与技术实现

本系统的机器学习模块（`risk_modelling/`）致力于构建一套从特征工程、模型训练到风险评分和解释的端到端智能风控解决方案。其核心能力包括：

#### 2.1 智能特征工程 (Intelligent Feature Engineering)

特征是机器学习模型的基石，高质量的特征能显著提升模型性能。本模块的特征工程体系涵盖：

*   **多维度基础特征提取**：
    *   **环路结构特征**：
        *   环路长度（节点数）、环路涉及总金额/平均金额、最大单笔交易金额。
        *   节点度分布特征（入度、出度、平均度、最大/最小度）。
        *   股权占比特征（环内平均持股比例、最小/最大持股比例、持股比例标准差）。
        *   路径特征（如环路中是否存在特定类型的节点序列）。
    *   **参与方（节点）属性特征**：
        *   企业工商信息：注册资本、成立年限、所属行业、经营状态、股东背景（如国企、民企、外资）、是否存在行政处罚/经营异常记录。
        *   个人属性信息（若适用且合规）：年龄、关键职位（董事长、总经理、财务负责人等）。
        *   网络中心性指标：节点的度中心性、介数中心性、紧密中心性、特征向量中心性，反映节点在网络中的影响力。
    *   **交易行为特征**：
        *   交易频率、交易金额的统计分布（均值、中位数、标准差、偏度、峰度）。
        *   与交易对手的互动特征（如交易对手数量、交易金额集中度）。
        *   资金流动特征（如特定时间窗口内的资金流入/流出总量、净流量）。
    *   **时间序列特征**：
        *   交易发生的时间特征（如是否为节假日、工作日/非工作日、月初/月末/季末/年末）。
        *   近期交易行为的趋势特征（如交易量/金额的环比/同比增长率）。
*   **动态与图基础特征生成**：
    *   **图嵌入技术 (Graph Embedding)**：利用Node2Vec, GraphSAGE, GCN等算法，将节点的结构信息和属性信息编码为低维、稠密的向量表示（Embeddings）。这些向量能捕捉节点间深层次的语义关联和相似性，作为下游模型的输入特征。
    *   **社区发现与社群特征**：通过Louvain, Infomap等社区发现算法识别网络中的紧密子群组，并将节点所属社区ID、社区规模、社区密度等作为特征。
    *   **路径与子图模式特征**：基于预定义的风险模式（如特定类型的资金回路、担保链），检测图中是否存在这些模式，并将其作为布尔型或计数型特征。
*   **特征选择与降维**：
    *   **过滤式选择 (Filter Methods)**：利用统计检验（如卡方检验、F检验）、相关系数（如皮尔逊相关系数）、互信息等指标评估单个特征与目标变量（风险标签）的相关性，剔除不相关或冗余特征。
    *   **包裹式选择 (Wrapper Methods)**：如递归特征消除（RFE），通过迭代训练模型并移除贡献最小的特征来进行特征选择。
    *   **嵌入式选择 (Embedded Methods)**：如L1正则化（Lasso），在模型训练过程中自动进行特征选择。
    *   **主成分分析 (PCA)**：用于高维特征空间的降维，提取主要信息，减少噪声。

#### 2.2 双重风险识别引擎 (Dual Risk Identification Engine)

结合监督学习和无监督学习，构建互补的风险识别能力：

*   **监督学习模型 (Supervised Learning for Known Risks)**：
    *   **目标**：精准识别与历史案例相似的、已有明确标签的已知风险模式。
    *   **模型选择**：
        *   **主流选择**：XGBoost、LightGBM等梯度提升决策树（GBDT）模型。优势在于：处理表格数据性能优越，能捕捉复杂的非线性关系，自带特征重要性评估，对缺失值有一定容忍度，并行计算效率高。
        *   **其他备选**：随机森林（Random Forest）、支持向量机（SVM）、逻辑回归（Logistic Regression，作为基线模型）。
    *   **样本构建与处理**：
        *   **正样本来源**：历史已确认的风险案例，如监管机构处罚公告、公开负面新闻报道、内部审计发现的违规事件、实际发生损失的业务等。
        *   **负样本构建**：从未发生风险或在一定观察期内表现正常的案例。负样本的选择对模型性能至关重要，需注意避免引入潜在未识别的风险案例。
        *   **标签定义**：明确定义风险标签（如"高风险"/"低风险"，或更细致的风险等级）。
        *   **处理样本不平衡**：金融风险事件通常是小概率事件，会导致正负样本比例严重失衡。处理方法包括：
            *   过采样（Oversampling）：如SMOTE (Synthetic Minority Over-sampling Technique)及其变种，人工合成少数类样本。
            *   欠采样（Undersampling）：随机剔除多数类样本，可能丢失信息。
            *   代价敏感学习（Cost-sensitive Learning）：在模型训练时赋予少数类样本更高的错分代价。
            *   集成方法：如EasyEnsemble, BalanceCascade。
    *   **模型训练与调优**：
        *   **数据划分**：将数据集划分为训练集、验证集和测试集。
        *   **交叉验证 (Cross-Validation)**：如K折交叉验证，用于更稳健地评估模型性能和选择超参数。
        *   **超参数优化**：使用网格搜索（Grid Search）、随机搜索（Random Search）或贝叶斯优化（Bayesian Optimization）等方法寻找最优的超参数组合，以防止模型过拟合或欠拟合。
        *   **性能评估指标**：准确率（Accuracy）、精确率（Precision）、召回率（Recall/Sensitivity）、F1分数、AUC-ROC（ROC曲线下面积）、AUC-PR（PR曲线下面积）。重点关注与业务目标一致的指标，如在风控场景下，召回率（查全率）往往更受重视。
        *   **应用场景举例**：识别已知的欺诈模式（如虚假贸易融资环路）、典型的关联交易非公允定价行为、具有特定特征的违约客户等。

*   **无监督异常检测 (Unsupervised Learning for Unknown/Anomalous Risks)**：
    *   **目标**：发现与正常行为模式显著不同的、事先未被标记的异常点或异常模式，预警潜在的未知风险或新型风险。
    *   **模型选择**：
        *   **基于密度的算法**：如LOF (Local Outlier Factor)，DBSCAN。通过比较对象邻域的密度来判断其是否为异常点。
        *   **基于距离的算法**：如K近邻（KNN）异常检测。
        *   **基于树的算法**：隔离森林（Isolation Forest）。通过随机切分特征空间来构建多棵隔离树，异常点通常能被更快地隔离出来，路径更短。计算效率高，适用于高维数据。
        *   **基于重构误差的算法**：如主成分分析（PCA）异常检测、自编码器（Autoencoder）。正常样本能够被模型很好地重构，而异常样本的重构误差较大。
        *   **单类支持向量机 (One-Class SVM)**：学习一个能够包围大部分正常数据的边界。
    *   **"正常模式"画像与学习**：
        *   首先需要定义和收集代表"正常"行为的数据集。这可能需要业务专家参与圈定，或选择一段时期内未发生已知风险事件的数据。
        *   模型在该正常数据集上进行训练，学习正常数据的分布和模式。
    *   **异常评分与预警**：
        *   对于新的待检测样本，模型会计算其偏离已学习的"正常模式"的程度，并输出一个异常分数。
        *   设定合适的预警阈值。当异常分数超过该阈值时，系统会将其标记为潜在异常，并发出预警，提示人工进一步分析。阈值的设定需要结合业务容忍度和历史数据进行调整。
        *   **应用场景举例**：发现从未见过的新型欺诈手法、数据录入或系统错误导致的异常数据点、与群体行为模式显著不符的个体行为、早期风险信号等。

#### 2.3 可解释的风险评分与洞察 (Explainable Risk Scoring & Insights)

为了增强模型的透明度和用户的信任度，提供模型决策的可解释性至关重要：

*   **风险评分输出**：
    *   模型不仅输出二分类的风险标签（例如，"高风险"/"低风险"），更重要的是提供一个连续的风险概率分数（通常在0到1之间）。这使得业务人员可以根据风险偏好设定不同的阈值，进行风险排序和分级管理。
*   **全局特征重要性分析 (Global Feature Importance)**：
    *   **模型内置方法**：对于树模型（如XGBoost, LightGBM, Random Forest），可以直接获取特征在所有分裂节点上的平均增益（Gain）、分裂次数（Split Count）或置换重要性（Permutation Importance）等。
    *   **SHAP (SHapley Additive exPlanations)**：一种基于博弈论的先进模型解释方法，可以计算每个特征对单个预测以及全局预测的贡献值（SHAP值）。SHAP值具有良好的理论基础和一致性。
*   **局部实例级解释 (Local Instance-level Explanation)**：
    *   **LIME (Local Interpretable Model-agnostic Explanations)**：通过在待解释实例的邻域学习一个简单的、可解释的代理模型（如线性模型、决策树）来近似复杂模型的局部行为。
    *   **SHAP 值（个体层面）**：SHAP同样适用于解释单个预测，清晰展示每个特征如何将预测结果从基线值推向最终值。
*   **决策路径与规则可视化**：
    *   对于决策树或基于树的集成模型，可以可视化单个决策树的判断路径，直观展示风险判定的逻辑。
    *   可以尝试提取模型中的关键决策规则（Rule Extraction），将其转化为人类可理解的语言。
*   **反事实解释 (Counterfactual Explanations)**：
    *   探索"如果某个（或某些）特征值发生最小的改变，预测结果会如何变化（例如，从高风险变为低风险）？" 这有助于用户理解改善风险状况的关键因素。
*   **应用价值**：
    *   帮助风控人员理解模型为何做出某一判断，增强对模型结果的信任。
    *   辅助进行误报分析，找出模型可能出错的原因。
    *   指导特征工程的优化方向。
    *   满足监管对模型透明度和公平性的要求。
    *   向业务部门解释风险成因，推动风险管理措施的落实。

### 3. 实际应用场景与价值体现

将上述机器学习能力融入风控业务流程，能够在多个环节创造显著价值：

*   **场景1：日常风险筛查与优先级排序**
    *   **业务痛点**：每日产生海量的交易数据和股权变更信息，人工审核团队面临巨大压力，难以高效、全面地识别所有潜在高风险目标。
    *   **机器学习解决方案**：
        1.  系统自动加载当日新增或发生变更的股权环路数据、交易数据等。
        2.  经过智能特征工程模块处理，为每个分析对象（如环路、企业）提取丰富的结构化特征。
        3.  将特征输入预训练的监督学习模型（如XGBoost）和无监督异常检测模型（如隔离森林），分别得到"已知风险评分"和"异常评分"。
        4.  设计一个综合评分策略（例如，对两个分数进行加权平均，或设定组合规则如"已知风险评分 > 阈值A OR 异常评分 > 阈值B"），得到最终的综合风险等级或排序。
        5.  系统根据综合风险等级对所有分析对象进行排序，将Top N个最高风险的对象优先推送给人工审核团队进行深度审查。
    *   **核心价值**：
        *   **大幅提升审核效率**：将有限的人工专家精力聚焦于最可疑、最有价值的案例上，减少在低风险或正常案例上的时间消耗。
        *   **提高风险识别精准度**：机器学习模型能够捕捉更复杂、更隐蔽的风险模式，减少人工审核的主观性和疏漏。
        *   **实现动态风险排序**：根据模型实时评分动态调整审核优先级，快速响应风险变化。

*   **场景2：新型与未知风险预警**
    *   **业务痛点**：传统的、基于历史经验的规则系统难以覆盖所有新兴的、未曾出现过的风险手法。
    *   **机器学习解决方案**：
        1.  持续监控无监督异常检测模型（如隔离森林、LOF、自编码器）的输出结果。
        2.  重点关注那些"异常评分"显著偏高，但"已知风险评分"（来自监督学习模型）不一定高的案例。这种情况可能意味着该案例与历史已知的风险模式不完全吻 chiffres，但其行为模式显著偏离了正常基线，有可能是新型风险的早期信号。
        3.  将这些"高异常、非典型已知风险"的案例推送给资深风控专家进行人工研判和调查。
        4.  如果经专家确认为一种新型风险，则收集相关案例的特征和标签，将其作为新的正样本加入到监督学习模型的训练集中，进行模型迭代和优化，从而增强系统对该新型风险的未来识别能力。
    *   **核心价值**：
        *   **弥补规则系统盲点**：主动发现超出历史经验和规则库范畴的潜在风险。
        *   **提前感知与预警**：缩短从新型风险出现到被识别和响应的滞后期，争取宝贵的应对时间。
        *   **驱动模型进化**：将新发现的风险模式反馈到模型训练中，实现风控知识库的动态更新和系统的持续学习。

*   **场景3：风险演化分析与风控策略优化**
    *   **业务痛点**：风险模式、欺诈手法以及市场环境并非一成不变，风控策略和模型参数需要随之动态调整才能保持有效性。
    *   **机器学习解决方案**：
        1.  定期（例如，每月或每季度）使用最新的、包含新标注案例的数据集重新训练风险模型（包括监督学习模型和可能的无监督模型基线）。
        2.  对比新旧模型的性能指标（如AUC、F1分数），评估模型是否出现性能衰减。
        3.  分析新模型输出的特征重要性排序与旧模型的差异，识别哪些风险因子的影响力在增强或减弱，这可能反映了风险关注点的转移。
        4.  追踪高风险群体的特征分布随时间的变化，例如，高风险交易的平均金额是否在上升，涉及的行业是否发生变化等，从而识别风险演化的新趋势。
        5.  基于上述分析结果，动态调整风控规则的参数、机器学习模型的阈值、特征工程的侧重点以及人工审核的策略和资源分配。
    *   **核心价值**：
        *   **保持风控体系的适应性**：确保风控策略和模型能够跟上风险环境的变化，避免因模型老化而导致的效能下降。
        *   **洞察风险趋势**：从数据驱动的角度理解风险是如何演变的，为前瞻性的风险管理提供依据。
        *   **优化资源配置**：根据风险演化的方向，更有效地分配审核资源和技术投入。

*   **场景4. 辅助信贷审批与贷后监控 (若适用)**
    *   **业务痛点**: 在信贷业务中，需要快速、准确地评估借款企业的潜在违约风险，并在贷后进行持续监控。
    *   **机器学习解决方案**:
        1.  **贷前评估**：整合借款企业的股权图谱信息（如是否存在复杂的循环持股、隐形控制人）、历史交易数据（如现金流稳定性、与上下游的交易健康度）、企业经营数据（财务报表、工商变更、涉诉信息）以及外部舆情信息，构建全面的企业风险画像。利用机器学习模型（如逻辑回归、GBDT）预测其在未来一定时期内发生信用违约的概率。
        2.  **贷后监控**：持续监测企业相关的各类数据，一旦出现显著的负面变化（如关键财务指标恶化、新增重大诉讼、股权结构发生不利变动、交易行为异常），机器学习模型可以实时更新风险评分，并触发预警，提示信贷经理关注。
    *   **核心价值**:
        *   **提升信贷决策的科学性与效率**: 为信贷审批提供更客观、数据驱动的风险评估依据，缩短审批时间。
        *   **有效控制信用风险**: 及早识别潜在的信用恶化信号，采取相应的风险缓释措施。
        *   **实现差异化贷后管理**: 根据风险评分对存量客户进行分级管理，对高风险客户加强监控频率和深度。


### 4. 部署与迭代策略：从辅助到智能

成功的机器学习应用并非一蹴而就，而是一个持续部署、监控、反馈和优化的过程。建议采用分阶段的策略：

*   **第一阶段：辅助决策与数据积累（"影子模式"运行）**
    *   **核心目标**：验证模型的初步有效性，积累高质量的标注数据，培养用户信任。
    *   **关键行动**：
        *   机器学习模型与现有规则系统并行运行，但其输出结果（风险评分、预警信号）**不直接**用于最终的业务决策。
        *   模型结果作为人工审核团队的**辅助参考信息**。例如，提示审核人员关注模型标记为高风险的案例。
        *   建立清晰、高效的**反馈机制**：业务专家对模型预警的案例进行复核，并将人工判断的结果（是否确为风险、风险类型等）作为新的标注数据反馈给模型团队。
        *   重点监控模型的预测准确性、稳定性，并与专家判断进行对比分析。
        *   此阶段是理解业务痛点、收集领域知识、打磨特征工程、积累高质量训练数据的关键时期。

*   **第二阶段：混合智能系统（人机协作增强）**
    *   **核心目标**：逐步提升机器学习在决策流程中的权重，优化人机协作效率。
    *   **关键行动**：
        *   当模型在一系列离线评估和"影子模式"验证中表现稳定，并获得业务部门一定程度的认可后，可以开始将机器学习评分**正式纳入**风险评估体系的一部分。
        *   **策略调整**：
            *   对于模型判断为**极低风险**的案例，可以适当降低人工审核的频率或抽样比例，甚至在特定条件下考虑实现自动通过（需严格设定置信度阈值和例外规则）。
            *   对于模型判断为**中高风险**的案例，则由人工审核团队进行重点、优先审核。
            *   探索将规则引擎与机器学习模型进行更深度的结合，例如，用规则处理简单明确的场景，用模型处理复杂模糊的场景。
        *   持续收集反馈，迭代优化模型，并开始关注模型的上线后监控指标（如实际业务中的误报/漏报情况、对业务指标的影响）。

*   **第三阶段：智能化自主升级与前瞻性风控**
    *   **核心目标**：构建更高级别的智能风控能力，实现从被动响应到主动预测和干预的转变。
    *   **关键行动**：
        *   在积累了足够的高质量数据和成熟的运营经验后，可以探索引入更前沿的机器学习和人工智能技术：
            *   **图神经网络 (GNN)**：直接在图结构数据上进行端到端的学习，能更有效地捕捉节点间的复杂关系和网络拓扑信息，适用于股权网络分析、交易网络反欺诈等。
            *   **强化学习 (Reinforcement Learning)**：用于动态风控策略优化，例如，在不同市场环境下自动调整风险阈值或干预措施。
            *   **自然语言处理 (NLP)**：用于从舆情、新闻、法律文书等文本信息中提取风险信号。
            *   **可解释性AI (XAI) 的深化应用**：提供更细致、更可靠的模型解释，甚至生成风险应对建议。
        *   目标是实现更高程度的自动化、更精准的实时风险监控、以及对未来风险趋势的预测能力，最终赋能更具前瞻性的风险管理决策。

### 5. 关键成功因素

一个成功的机器学习风控系统的落地，除了先进的技术外，还需要关注以下关键因素：

*   **高质量、足量的标注数据**：这是监督学习的基石。"Garbage in, garbage out." 必须投入资源整理历史风险案例，建立清晰、一致的标注规范，并持续获取新的标注数据。
*   **深度业务理解与领域知识的融入**：技术人员需要与风控业务专家紧密合作，将业务经验和领域知识有效融入到特征工程、模型设计和结果解读中。
*   **强大的特征工程能力**：好的特征往往比复杂的模型更重要。需要持续探索和构建能够有效区分风险与正常的特征变量。
*   **完善的模型监控与迭代机制**：模型性能会随时间推移和外部环境变化而衰减（模型漂移）。必须建立一套有效的监控体系，定期评估模型表现，并根据需要进行再训练和迭代优化。
*   **清晰的业务目标与合理的预期管理**：明确机器学习要解决的具体业务问题以及期望达成的效果，避免对AI有过高或不切实际的期望。
*   **跨部门的协作与支持**：机器学习项目的成功通常需要数据团队、技术团队、业务团队以及管理层之间的紧密协作和支持。
*   **关注可解释性和用户信任**：提供必要的模型解释，帮助业务用户理解和信任模型的输出，是推动模型在实际业务中被采纳的关键。
*   **合规性与伦理考量**：确保数据的获取和使用符合相关法律法规要求，关注模型可能存在的偏见问题。

### 6. 预期效果与价值展望

通过上述设计和实施，本机器学习赋能的图风控系统有望实现以下核心价值：

*   **显著提升风险识别效率**：通过自动化分析和智能排序，预计可将人工审核的工作量减少60%-80%，使风控团队能更聚焦于高价值的复杂风险研判。
*   **有效提升风险识别的准确率与召回率**：机器学习模型能够挖掘人工难以察觉的隐蔽风险模式，从而更全面地识别风险（提高召回率），同时通过精准画像减少误判（提高精确率）。
*   **大幅缩短风险响应时间**：从海量数据中快速识别潜在风险信号，将风险从产生到被发现的周期从传统的天级、周级缩短到小时级甚至分钟级。
*   **增强对新型和未知风险的洞察能力**：利用无监督学习主动发现异常模式，为防范和应对新兴风险争取主动。
*   **实现风控知识的沉淀与智能化升级**：将专家的经验和新发现的风险模式融入持续迭代的机器学习模型中，形成一个能够自我学习、自我进化的智能风控大脑。
*   **优化资源配置，降低运营成本**：通过智能化手段提升工作效率，合理分配人力和技术资源，从而在控制风险的同时降低整体运营成本。
*   **支持更精细化的风险管理与决策**：基于多维度、动态的风险评分，企业可以实施更具针对性的风险缓释措施和差异化的管理策略。

最终，本系统旨在通过人机协作，将贵公司的风险控制能力提升到一个全新的水平，使其在日益复杂的商业环境中更加稳健、高效地运行。

---
如需详细API与二次开发说明，请查阅本目录下相关源码与注释，或联系技术支持团队。 